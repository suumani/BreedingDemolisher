# Breeding Demolisher — Specification (spec)

This document records the **design intent, specifications, and agreed rules**
of the Breeding Demolisher mod.

Its purpose is to preserve decision criteria, priority rules, and the boundary
between *intended behavior* and *bugs* that cannot be fully described in the
Mod Portal or README.

---

## Terminology

In this mod, the following terms are used with **explicit, design-specific meanings**.
They do not necessarily match their general English usage.

- **default**
  - Refers to the *Space Age core demolishers* provided by the official Space Age mod.
  - Includes only:
    - `small-demolisher`
    - `medium-demolisher`
    - `big-demolisher`
  - These units are automatically placed during map generation and expansion,
    and are **not targets that this mod attempts to suppress or control**.

- **normal**
  - Refers to the *standard evolution line* in Factorio enemy design.
  - Includes:
    - `small / medium / big`
    - `behemoth` (added by this mod)
  - The term does **not** mean “ordinary” or “non-special”.

- **additional**
  - Refers to demolisher variants introduced by this mod that extend the standard line.
  - Example: `speedstar` variants.

- **fatal**
  - Refers to demolishers whose size, speed, or terrain impact is extreme.
  - These are excluded from regular breeding and relocation logic.
  - Example: `gigantic`, `crazy-king` series.

---

## 0. Purpose and Non-goals

### 0.1 Purpose
- To treat demolishers not as one-time threats, but as a **growing ecosystem**
- To ensure that neglect increases danger, while **caps and control logic**
  prevent performance collapse
- To create meaningful player decisions around **containment, thinning, and breeding**

### 0.2 Non-goals
- Guaranteeing a consistently safe or manageable difficulty
- Reducing eggs or breeding to a mere collection mechanic
- Replacing all global enemy behavior systems

---

## 1. Mod Positioning
- Category: Content Addition / Enemies
- Target: Factorio 2.0 (Space Age)
- Core Experience: Managing proliferating demolishers through
  **hunt / neglect / controlled breeding**

---

## 2. Core Gameplay Loop
1. Eggs are generated over time or through combat
2. Eggs hatch, increasing the population
3. Population growth creates pressure, requiring control or intervention
4. The player chooses between **containment, culling, or breeding**

---

## 3. Natural Breeding (Wild)

### 3.1 Purpose of Population Caps
- Population caps exist primarily for **UPS and performance stability**
- However, unrestricted inclusion of all demolishers in cap calculation would
  prevent breeding events in large, heavily explored maps
- Therefore, cap logic is designed to:
  - Preserve performance
  - Ensure breeding events still occur in large worlds

### 3.2 Counted Population (Cap Calculation Rules)
Population caps are applied to a **counted population**, defined as follows:

#### Excluded from Cap Calculation
The following demolishers are excluded from cap calculation:

- **Default (Space Age core) demolishers**
  - `small / medium / big`
- **Only when** their quality is:
  - `nil`, or
  - `normal`

Notes:
- Default demolishers with customized quality are *not* excluded
- All demolishers added by this mod or related mods are included
- Default demolishers are auto-generated by map expansion and are not controllable
  by this mod, nor intended to be suppressed

### 3.3 Evolution-Dependent Cap Values
The population cap increases with evolution factor.

#### Evolution Factor → Cap (counted population)
- evo ≤ 0.05 → 40  
- evo ≤ 0.15 → 55  
- evo ≤ 0.25 → 70  
- evo ≤ 0.35 → 85  
- evo ≤ 0.45 → 100  
- evo ≤ 0.55 → 115  
- evo ≤ 0.65 → 130  
- evo ≤ 0.75 → 145  
- evo ≤ 0.85 → 160  
- evo ≤ 0.95 → 175  
- evo ≤ 0.98 → 190  
- evo > 0.98 → 200  

---

## 4. Player Interaction and Pets
- Eggs may be obtained by defeating wild demolishers
- Demolishers hatched from eggs are treated as *pets*
- Pets may have alignment states (hostile / neutral / friendly)
- Mature pets may begin breeding
- Offspring may inherit traits or abilities from parents

---

## 5. Difficulty and Pressure Design
- This mod targets players who prefer **high-risk, high-density combat**
- Early-game unfairness is mitigated while **late-game pressure increases**
- Pressure scales via:
  - Population caps
  - Mutation rates
  - Movement and relocation pressure

---

## 6. Movement Behavior and Pressure Diffusion

### 6.1 Movement Target Policy
- This mod assumes large-scale map expansion with many default demolishers
  and does not attempt to suppress them
- Instead, cap calculation is adjusted so that breeding-based pressure
  remains effective
- Movement control targets are limited to:
  - **manis-small / manis-medium / manis-big**
- Gigantic and King-class demolishers are excluded due to excessive
  terrain and combat impact
- Target selection and execution are handled by dedicated
  **MovePlanner / Executor** logic

### 6.2 Periodic Movement
- Movement evaluation occurs approximately **once per minute**
- The goal is pressure redistribution and shifting front lines
- Destinations are chosen within generated chunk boundaries

### 6.3 Density Cleanup (Legacy Save Remediation)
- Some legacy saves contain **unintended high-density clusters**
  of default demolishers
- These clusters are the result of older mod behavior and are not bugs
- They are treated as **ecosystem correction (cleanup)**

#### Cleanup Rules
- Targets:
  - **Default demolishers**
  - **No quality filtering is applied**
- Detection:
  - A small random sample (e.g. up to 5 entities) is examined
  - If ≥ N entities (e.g. 5) are found within a fixed radius (e.g. 50 tiles),
    the area is classified as an abnormal cluster
- Effect:
  - Exactly **one demolisher** from that cluster is added as an extra movement target
- Constraints:
  - At most one cleanup move per evaluation
  - Lightweight checks are mandatory for performance stability

---

## 7. Egg Mutation (Evolutionary Breeding)

### 7.1 Basic Rule
- Eggs normally hatch into the same species as the parent
- At certain evolution thresholds, eggs may **mutate** into higher or derived species
- Mutation replaces only a portion of eggs; lower-tier eggs continue to appear

### 7.2 Mutation Rate
- At the threshold: **10%**
- At evolution 1.0: **30%**
- Linear interpolation between the two

### 7.3 Mutation Evaluation
- Mutation is evaluated **once per egg**
- If mutation occurs, the target species is selected
  from a **mutation target table**
- Multiple mutation rules never stack

---

## 7.4 Main Evolution Line (Primary)
- evo ≥ 0.25: `small → medium`
- evo ≥ 0.50: `medium → big`
- evo ≥ 0.75: `big → behemoth` (if available)

### 7.5 Derived Evolution (Speedstar Series)
- evo ≥ 0.85: `medium → speedstar small`
- evo ≥ 0.95:
  - `big → speedstar medium`
  - `speedstar small → speedstar medium`
- evo ≥ 0.98:
  - `behemoth → speedstar big`
  - `speedstar medium → speedstar big`

### 7.6 Mod Dependency
- Speedstar, Gigantic, and King-class demolishers are introduced by **other related mods**
- If the relevant mod is not installed, the corresponding mutation rules are ignored

---

## 8. Excluded Species (Fatal Classes)
- Fatal classes such as `gigantic` and `crazy-king` are excluded from breeding mutation
- These entities are intended to appear only through **events or scripted spawns**

---

## 9. Determinism and Multiplayer
- All randomness must be deterministic
- RNG is centrally managed
- Any desynchronization or reproducibility issue is treated as a bug

---

## 10. Save Data
- Global data is stored under `storage`
- Any change requiring migration must explicitly document migration steps

---

## 11. Status of This Specification
- This document takes precedence over README and Mod Portal descriptions
- When implementation diverges:
  - Either the implementation is accepted as correct, or
  - The specification must be explicitly updated