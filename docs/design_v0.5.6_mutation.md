# BreedingDemolisher v0.5.6  
## Mutation / Inheritance Redesign – Design Notes

---

## この文書について

この文書は **BreedingDemolisher v0.5.6** における  
**mutation（遺伝・進化）および勢力遷移ロジックの内部設計メモ**である。

- プレイヤー向け仕様は `spec.md`
- 変更履歴は `CHANGELOG.md`

本資料はそれらとは異なり、  
**実装の意図・前提・設計上の制約・判断理由**を記録することを目的とする。

将来の保守・拡張・再設計時に  
「なぜこの設計になっているのか」を即座に思い出せることを重視する。

---

## 1. 背景と目的

v0.5.6 では、以下の問題意識から mutation ロジックの全面的な見直しを行った。

- 遺伝ロジックが断片的に存在し、暗黙仕様が多かった
- `new` と `mutate` の責務が混在していた
- 勢力（懐き）と遺伝の関係が言語化されていなかった
- size / speed / max_* / traits などの進化速度と意味が揃っていなかった

本リリースでは **ゼロベース再設計は行わない**。  
既存仕様・既存実装を尊重しつつ、

- 遺伝の共通モデルを明確化
- すべてのパラメータを同一の思想で扱う
- 将来拡張に耐える内部構造を定義

することを目的とする。

---

## 2. 基本設計方針（大原則）

### 2.1 共通原則

- すべての遺伝は **2段階遺伝モデル**
- `new` は **変動しないデータコンテナ**
- 遺伝値は自由に変動させる  
  → **生成時（create entity）にのみクランプ**
- 勢力は「懐き段階」であり、**卵の勢力として確定**
- 情報削除は行わず、**非発現（潜性）**で表現する

---

## 3. 2段階遺伝モデル（全パラメータ共通）

### 第1段階：両親形質引継ぎ

- パラメータごとに **基準親** をランダム選択
- もう片親の方向へ **少量引っ張る**
- 引っ張り量は **基準親の値に比例した上限**
- 結果は **両親の [min, max] 範囲内にクランプ**

> 差分％ではなく「親個体のスケールに比例」することで  
> 巨大×小型の交配でも暴走しない設計とする。

### 第2段階：突然変異（mutation）

- 対称（±）のランダム変動
- 両親レンジを **超えることを許容**
- 勢力・両親数による **平均ドリフト** を適用

### 片親の場合

- 親の値を基準とする
- **不利補正**を適用（懐き・進化しにくい）
- 繁殖は成立するが、進化速度は落ちる

---

## 4. 勢力遷移（懐き）設計

### 4.1 勢力の意味

- **enemy** : 野生段階
- **demolishers** : 中間・準友好段階
- **player** : 懐いた段階

勢力は個体ではなく **卵（次世代）で確定**する。  
孵化後の勢力変更は mutation の対象外。

---

### 4.2 両親あり・基準遷移行列

| 親勢力 | 遷移先 enemy | demolishers | player |
|------|-------------|-------------|--------|
| enemy | 60% | 40% | – |
| demolishers | 30% | 40% | 30% |
| player | 10% | 30% | 60% |

### 両親の勢力が異なる場合
- 各親の遷移行列を **等重み平均**して抽選する。

---

### 4.3 片親補正（方式P）

片親の場合は **懐かない方向へ補正**する。

| 親勢力 | 遷移先 enemy | demolishers | player |
|------|-------------|-------------|--------|
| enemy | 80% | 20% | – |
| demolishers | 55% | 30% | 15% |
| player | 15% | 40% | 45% |

---

### 4.4 研究補正（無限研究）

- 各遷移確率は **研究で有利方向に収束**
- 上限値を持ち、**指数収束**
- 半減期：**2**

#### 研究∞時の上限
- enemy → demolishers：最大 60%
- demolishers：
  - → player：最大 60%
  - → enemy：最小 15%
- player：
  - → enemy：最小 5%
  - → demolishers：最小 15%
  - → player：差分（最大 80%）

#### 適用順序
1. 基準行列 + 研究補正
2. 片親補正
3. 正規化して抽選

---

## 5. 遺伝パラメータ仕様

（※この章は **v0.5.6 で完全実装済み**）

### 5.1 quality（内部値）

- 連続値、**負の値も許容**
- 他パラメータには影響しない
- Factorio の 5段階 quality への変換は  
  `QualityUtil.to_item_quality_name(q)` に委譲
- v0.5.6 では **既存マッピングを変更しない**

---

### 5.2 size

- 2段階遺伝を適用
- **player 勢力は大きくなりやすい**
- 生成時クランプ（上限）：

| 種別 | size 上限 |
|------|-----------|
| SMALL | 30,000 |
| MEDIUM | 100,000 |
| BIG | 300,000 |
| Behemoth | 1,000,000 |

- `evolve_entity` はこの定義に準拠

---

### 5.3 speed

基準値：

| 種別 | base speed |
|------|------------|
| SMALL | 4.0 |
| MEDIUM | 4.3 |
| BIG | 4.7 |
| Behemoth | 5.4 |

Speedstar 系：

| 種別 | base speed |
|------|------------|
| SMALL | 6.1 |
| MEDIUM | 6.8 |
| BIG | 7.6 |
| Behemoth | 8.3 |

生成時クランプ：
- **基準値 × [0.5, 2.0]**

---

### 5.4 max_life / max_growth / max_satiety

#### 生成時レンジ

**max_life**
- min 120
- max: 180 / 240 / 300 / 360

**max_growth**
- min 30
- max: 50 / 75 / 100 / 125

**max_satiety**
- min 75
- max: 100 / 150 / 200 / 250

（順に SMALL / MEDIUM / BIG / Behemoth）

#### 突然変異（第2段階）
- 固定量変動（方式S）
  - life ±2
  - growth ±1
  - satiety ±3
- 両親・勢力による平均ドリフトあり

---

## 6. traits（特性）設計

### 表現
- **特性 = ID + 強度（数値）**
- 強度は **負の値も保持**

### 継承（第1段階）
- 両親の特性は **和集合**
- 同一特性は **強い方（max）を採用**

### 欠落の再定義
- 削除は行わない
- 欠落 = **非発現**
- 発現判定は生成時に **特性ごとの閾値**で行う

### 突然変異（第2段階）
- 一定確率で新規特性を追加
- 強度変動により発現/非発現が自然に切り替わる

※ v0.5.6 では **特性の効果自体は未実装**。  
本リリースでは **遺伝・保持・発現判定の枠組みのみを確定**する。

---

## 7. v0.5.6 実装到達点（今回のスコープ）

v0.5.6 では、以下が **実装済み・確定事項**である。

- 2段階遺伝モデルの完全統一
- 勢力遷移（両親・片親・研究補正）のロジック実装
- size / speed / max_* の生成時クランプ
- traits の遺伝・非削除モデル
- customparam の責務整理（mutate の委譲化）

一方、以下は **設計のみ確定し、挙動は未接続**である。

- 研究レベルを実ゲーム進行から取得する処理
- traits の実効果発動（warp / heal / buff 等）

---

## 8. v0.5.7 以降で行う予定のこと

### 8.1 traits 効果の段階的実装
- cooldown 管理
- trigger 判定
- 効果実装（warp / heal / buff / shield 等）

### 8.2 研究と遺伝の接続
- 研究進行度を勢力遷移・traits 発現に反映
- UI への可視化（研究で何が変わるか）

### 8.3 派生種・派生進化の拡張
- 新規派生 trait
- 特定 trait 所持時の派生分岐

---

## 9. 結語

v0.5.6 の mutation 再設計は、

- **統一された遺伝モデル**
- **明示的な勢力遷移**
- **不可逆破壊を避ける設計**

を実現することを目的とする。

本資料は実装よりも **判断の記録**であり、  
将来の修正・拡張時の判断基点として残される。