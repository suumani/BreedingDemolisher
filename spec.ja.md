# Breeding Demolisher — 仕様書（spec）

本書は Breeding Demolisher の **設計意図・仕様・合意事項** を記録するためのドキュメントである。  
Mod Portal / README では説明しきれない「判断基準」「仕様の優先順位」「バグと仕様の境界」を保持することを目的とする。

---

## 0. 目的と非目的

### 0.1 目的（Purpose）
- デモリッシャーを「単発の脅威」ではなく、**増殖する生態系（Ecosystem）**として扱う体験を提供する
- 放置すると脅威が増大する一方で、**上限・制御ロジック**によりゲームが破綻しない範囲に収める
- 高密度戦闘・封じ込め・資源配分（討伐／放置／飼育）の意思決定を発生させる

### 0.2 非目的（Non-goals）
- 常にプレイヤーが安全に管理できる難易度を保証しない
- 卵・繁殖を「単なる収集要素」にしない（放置の代償を必ず残す）
- グローバルな敵挙動を全面的に置換することは目的としない

---

## 1. Mod の位置づけ
- 分類：コンテンツ追加 / Enemies
- 対象：Factorio 2.0（Space Age）
- コア体験：増殖するデモリッシャーを「狩る／放置する／飼う」で管理する

---

## 2. 基本ループ
1. 時間経過や戦闘により卵が生成される
2. 卵が孵化し、個体数が増える
3. 個体数増加が圧力となり、防衛・討伐・移動制御が必要になる
4. プレイヤーは「封じ込め／間引き／飼育」を選ぶ

---

## 3. 自然繁殖（Wild）

### 3.1 個体数キャップ（cap）の目的
- cap はパフォーマンス（UPS）安定化のために導入する
- ただし「広大なマップ開拓により標準デモリッシャーが広域に自然配置される」ケースでは、
  cap の計算対象を無差別にすると繁殖イベントに遭遇できなくなる
- よって cap は **「繁殖・追加コンテンツとして増えるべき対象」を止めない**ために、
  カウント対象を調整する

### 3.2 cap の計算対象（counted population）
- cap の判定に用いる個体数（counted population）は、敵勢力のデモリッシャーのうち以下を除外する：

#### 除外条件（capから減算する個体）
- **標準3種（small / medium / big）**
- かつ **quality が `nil` または `normal`**

補足：
- 標準3種でも quality がカスタマイズされている場合（normal以外など）は除外しない
- 標準3種以外のデモリッシャーは、本Mod（および関連Mod）で追加された個体であり、capの計算対象に含める
- quality がカスタマイズされていない標準3種は「マップ開拓により自動配置されるオリジナル」であり、
  本Modが防ぐべき対象でも、防ぐ手段を持つ対象でもないため除外する

### 3.3 進化度に応じた cap（進行依存）
- cap は進化度（evolution factor）に応じて段階的に増加する
- 進化度が高いほど、個体数上限が増え「終盤ほど波の圧力が増す」設計とする

#### 進化度 → cap（counted population の上限）
- evo ≤ 0.05 → cap 40  
- evo ≤ 0.15 → cap 55  
- evo ≤ 0.25 → cap 70  
- evo ≤ 0.35 → cap 85  
- evo ≤ 0.45 → cap 100  
- evo ≤ 0.55 → cap 115  
- evo ≤ 0.65 → cap 130  
- evo ≤ 0.75 → cap 145  
- evo ≤ 0.85 → cap 160  
- evo ≤ 0.95 → cap 175  
- evo ≤ 0.98 → cap 190  
- evo > 0.98 → cap 200  

### 3.4 卵の種別（species）決定ルール
- 卵は原則として **親と同種**のデモリッシャーを孵化させる
- ただし進化度（evolution factor）が一定以上になると、卵は一定確率で **上位種／派生種へ変異（mutation）**する
- 変異は「置換」ではなく「混在」であり、下位種の卵も一定割合で残る

### 3.5 変異確率（mutation rate）
- 親が変異卵を産む確率は、閾値到達時点で **10%**、進化度 **1.0 で 30%** となるように進化度依存で増加する
- 共通ルール：
  - evo < t の場合：変異率 0%
  - evo ≥ t の場合：変異率は 10% → 30%（evo=1.0）へ線形増加

> ※上記の「閾値到達時点10% / 1.0で30%」は、以下の各変異ルールに共通して適用する。

### 3.6 変異判定の方式（重要）
- 変異判定は **親ごとに1回だけ**行う
- 変異が成立した場合、変異先は **変異先テーブル**から抽選する
- 同一親に複数の変異先が存在する場合でも、確率が二重に乗らないようにする

---

## 3.7 正統進化（主系統）
正統進化は本Modの主系統であり、派生種より優先して維持される。

変異閾値
- evo ≥ 0.25  
  - **small** が **medium** の卵へ変異（mutation）し得る
- evo ≥ 0.50  
  - **medium** が **big** の卵へ変異し得る
- evo ≥ 0.75  
  - **big** が **behemoth** の卵へ変異し得る（behemothが存在する場合）

> ※behemothは本Modにより追加される「normal」系列の上位種である。

---

## 3.8 派生進化（speedstar 系）
speedstar 系は派生系列として扱うが、系列内にも正統進化を持つ。
- speedstar 系は、本Mod単体では存在しない派生系列である
- speedstar 系は、**関連Mod（例：SpeedstarDemolisher / BossDemolisher 系Mod）**
  が導入されている場合にのみ有効となる拡張進化ルールとして扱う
- 該当Modが導入されていない場合、本節に記載された変異ルールは無視される

変異閾値
- evo ≥ 0.85  
  - **medium** が **speedstar small** の卵へ変異し得る（派生の入口）
- evo ≥ 0.95  
  - **big** が **speedstar medium** の卵へ変異し得る  
  - **speedstar small** が **speedstar medium** の卵へ変異し得る（系列内正統進化）
- evo ≥ 0.98  
  - **behemoth** が **speedstar big** の卵へ変異し得る  
  - **speedstar medium** が **speedstar big** の卵へ変異し得る（系列内正統進化）

---

## 3.9 変異先テーブルの運用方針
- 同一親に複数の変異先がある場合、変異先はテーブル抽選で決定する
- 派生（speedstar）は主系統（正統進化）を壊さない範囲で出現させる
- 具体的な比率（重み）はバランス調整対象であり、仕様として固定しない（必要に応じて追記する）

---

## 3.10 繁殖対象外（FATAL 系など）
- gigantic / crazy-king 等の **FATAL 系**は、
  **関連Mod（例：BossDemolisher 系Mod）**によって追加されるデモリッシャーである
- これらはサイズ・移動力・地形影響が極端に大きいため、
  本Modの繁殖・変異ルートには含めない
- FATAL 系を出現させる場合は、
  **イベント・シナリオ・専用スポーン処理**など、
  繁殖とは異なる経路で管理することを前提とする


---

## 4. プレイヤー介入・ペット（Pet Demolishers）

### 4.1 ペット化
- 野生デモリッシャー撃破時、条件により **卵をドロップ**する
- 卵から孵化した個体は「ペット」として扱われる
- ペットは以下の勢力を持つ：
  - enemy（野生）
  - demolishers（新種）
  - player（友好的）

### 4.2 成長
- ペットは **周囲の敵を撃破することで成長度（growth）を獲得**する
- 成長度は内部パラメータとして保持され、UI から確認可能
- 成長度は繁殖・進化・死亡時ドロップの判定に用いられる

### 4.3 繁殖（ペット）
- 繁殖判定は **約1分に1回** 行われる
- 繁殖の基本条件：
  - 親が成熟している（growth ≥ 20）
  - 親が **新しい成長段階（20ごと）に到達**している
- 同一成長段階につき、**1回のみ繁殖チャンス**が発生する

### 4.4 繁殖相手の探索
- 繁殖チャンスが発生した親は、周囲のペットを探索する
- 条件を満たす相手が複数いる場合：
  - **最も近い成熟個体**が自動的に選択される
- 探索半径は設計上広めに取られ、実用上成立しやすい値(半径240程度)とする

### 4.5 繁殖結果
- 成熟相手が存在する場合：**両親繁殖**
- 相手が存在しない場合：**繁殖は発生しない**（v0.5.5 時点）
- 繁殖により **遺伝情報を持つ卵**が生成される
- 繁殖イベント発生時は、ユーザに明確な通知が表示される

---

## 5. 遺伝情報（Genetics）

### 5.1 遺伝情報の保持方式
- 遺伝情報は **卵の item tag** として保持される
- 遺伝情報は以下を通して保持される：
  - 輸送
  - 保管
  - スタック
  - 孵化

### 5.2 遺伝の継承
- 繁殖で生まれた卵は、親の特性・品質を引き継ぐ可能性がある
- 両親繁殖は、単独由来よりも有利な結果になりやすい設計とする

---

## 6. 卵の加工・進化ルート

### 6.1 惑星制約（重要）
- デモリッシャーは **ヴルカヌス原産**の生物である
- 卵の以下の処理は **ヴルカヌスでのみ可能**とする：
  - サイズ進化（小 → 中 → 大）
  - 新種進化
  - 凍結 / 解凍
- 制約は **気圧 4000** の surface condition により実装される

### 6.2 進化ルートの二系統
新種進化には、以下の **二系統ルート**が存在する。

#### A. 低温プラント（確定ルート）
- 高コスト・確定結果
- エンドゲーム向け
- 成功時、新種デモリッシャー卵を得る

#### B. バイオチャンバー（確率ルート）
- 高コスト・確率結果
- 成功率：**20%**
- 失敗時：**spoilage を生成**
- 中〜終盤の挑戦的選択肢

### 6.3 新種と友好デモリッシャー
- 新種デモリッシャー（force=demolishers）は **中間進化段階**
- 最終的に、**友好的なデモリッシャー（force=player）**へと至る
- この進化関係はレシピおよび説明文で明示される

---

## 7. 死亡時の卵ドロップ

- ペットが死亡した際、条件により卵をドロップする
- 判定条件：
  - 成長度（growth）が一定以上であること
- ドロップする卵の種別は、ペットの勢力に依存する
- ペット死亡時は、**専用の通知**が表示される

---

## 8. 難易度・圧力設計
- cap は「単に増殖を抑える」ためではなく、以下を両立するために設計される：
  - パフォーマンス（UPS）安定
  - 進行に応じた圧力増大（終盤ほど波が強くなる）
  - 広大マップでも繁殖イベントが停止しない（標準3種の自然配置による阻害を回避）

---

## 9. 移動挙動と圧力の拡散

### 9.1 移動対象の基本方針
- 本Modは、広域開拓により **標準3種（small / medium / big）が多数存在する状況**を前提とし、
  それ自体を抑制・禁止しない
- その代わり、繁殖・追加個体による圧力がゲーム体験として成立するよう、
  cap の **「計算対象」** を調整する
- Breeding Demolisher Mod が扱う **移動制御対象** は以下に限定される：
  - **manis-small / manis-medium / manis-big**
- Gigantic 系・King 系のデモリッシャーは、
  **地形影響および戦闘負荷が過大であるため**、本 Mod の移動制御対象外とする
- 移動対象の抽選および実行は、専用の **MovePlanner / Executor** により制御される

### 9.2 定期移動（通常）
- 移動処理は **約1分に1回** の周期で評価される
- 移動は「圧力の分散」と「戦線の変遷」を主目的とする
- 移動先は、生成済みチャンク範囲を基準として決定される

### 9.3 密集掃除（過去データ汚染対策）
- 過去の Mod により、
  **default デモリッシャーが意図せず一地域に高密度で存在する**
  セーブデータが存在する
- これらは当時の仕様に基づく挙動であり、
  品質（normal / non-normal）による区別は行われていなかった
- 本 Mod では、これらを **バグ修正ではなく、生態系の是正（cleanup）** として扱う

#### 掃除ルール
- 対象：
  - **default デモリッシャー**
  - **品質によるフィルタは行わない**
- 方法：
  - 毎回すべてを走査せず、
    **ランダムに少数（例：最大5体）をサンプル**
  - サンプル個体の周囲一定半径（例：50タイル）に
    一定数以上（例：5体以上）が存在した場合、
    その地域を「異常密集」と判定する
- 効果：
  - 異常密集が検出された場合、
    **その密集地からランダムで1体のみ**を移動対象として追加する
- 制約：
  - 掃除による追加移動は **1回の評価につき最大1体**
  - パフォーマンス安定性を最優先し、軽量な判定を採用する
---

## 10. ロケット発射への反応（振動特性）
- ゲーム中盤以降、ロケットが発射されると、
  デモリッシャーは一定サイクル内で徐々にサイロへ向かう
- これは「活動（振動）への嫌悪」という特性として表現される

---

## 11. 決定性・マルチプレイ
- 乱数は deterministic な手法を用い、マルチプレイでの再現性を前提とする
- RNG は Mod 内で一元管理される
- 再現性に問題が見つかった場合は **バグとして扱う**

---

## 12. セーブデータ
- 使用するグローバルデータ：`storage` 配下（キーは実装に準拠）
- データ移行が必要な変更を行う場合は、更新手順を明記する

---

## 13. 本 spec の扱い
- 本書は README および Mod Portal の記述より優先される
- 実装と乖離が生じた場合：
  - 実装を仕様とみなすか
  - spec を更新するか
  を明示的に判断する
